import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import numpy as np

# -----------------------------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì •
# -----------------------------------------------------------------------------
st.set_page_config(
    page_title="Career Balance & Holland",
    page_icon="ğŸ§­",
    layout="wide"
)

# -----------------------------------------------------------------------------
# 2. ë°ì´í„° ë¡œë“œ (ë‚´ì¥ ë°ì´í„° - ì´í•© 100ì  ê¸°ì¤€)
# -----------------------------------------------------------------------------
@st.cache_data
def load_data():
    data = {
        'ì§ì—…êµ°': [
            'ì „ëµ ì»¨ì„¤í„´íŠ¸', 'ì™¸êµ­ê³„ íˆ¬ìì€í–‰(IB)', 'ëŒ€í˜• ë¡œíŒ ë³€í˜¸ì‚¬', 'ê³µì¸íšŒê³„ì‚¬(Big4)', 'ì‚¬ëª¨í€ë“œ(PE) ì‹¬ì‚¬ì—­',
            'ë„¤ì¹´ë¼ì¿ ë°° ê°œë°œì', 'ìœ ë‹ˆì½˜ ìŠ¤íƒ€íŠ¸ì—… ì§ì›', 'ê²Œì„ ê°œë°œì', 'AI ì—°êµ¬ì›/ì—”ì§€ë‹ˆì–´', 'ëŒ€ê¸°ì—… ì „ëµê¸°íš',
            'ì¦ê¶Œì‚¬ ë¸Œë¡œì»¤/PB', 'ì‹œì¤‘ì€í–‰ í–‰ì›', 'ê³µê¸°ì—… (ë©”ì´ì €)', 'ê³µê¸°ì—… (ì§€ë°©ê·¼ë¬´)', '7/9ê¸‰ ê³µë¬´ì›',
            '5ê¸‰ í–‰ì •ê³ ì‹œ ì‚¬ë¬´ê´€', 'ì´ˆë“±/ì¤‘ë“± êµì‚¬', 'ëŒ€í•™êµ êµì§ì›', 'ëŒ€í•™ êµìˆ˜', 'êµ­ì±…ì—°êµ¬ì†Œ ì—°êµ¬ì›',
            'ì˜ì‚¬ (ì „ë¬¸ì˜)', 'ì¹˜ê³¼ì˜ì‚¬', 'ì•½ì‚¬', 'ê°„í˜¸ì‚¬ (ëŒ€í•™ë³‘ì›)', 'ìˆ˜ì˜ì‚¬', 'í•œì˜ì‚¬',
            'ë°©ì†¡êµ­ PD', 'ë°©ì†¡ê¸°ì/ì•„ë‚˜ìš´ì„œ', 'ì›¹íˆ°/ì›¹ì†Œì„¤ ì‘ê°€', 'ì—”í„°í…Œì¸ë¨¼íŠ¸ A&R', 'ê´‘ê³ ê¸°íšì (AE)',
            'íŒ¨ì…˜ MD/ë°”ì´ì–´', 'í•­ê³µê¸° ì¡°ì¢…ì‚¬(íŒŒì¼ëŸ¿)', 'ê°ì‹¤ ìŠ¹ë¬´ì›', 'í˜¸í…”ë¦¬ì–´/ì§€ë°°ì¸', 'ì…°í”„/ìš”ë¦¬ì‚¬',
            'ë°˜ë„ì²´ ì—”ì§€ë‹ˆì–´', 'ë°°í„°ë¦¬/2ì°¨ì „ì§€ ì—°êµ¬ì›', 'ìë™ì°¨ ì—”ì§€ë‹ˆì–´', 'ì„ìœ í™”í•™/ì •ìœ  ì—”ì§€ë‹ˆì–´', 'ì œì•½/ë°”ì´ì˜¤ ì—°êµ¬ì›',
            'ê±´ì„¤/í† ëª© ì—”ì§€ë‹ˆì–´', 'ìŠ¤ë§ˆíŠ¸íŒœ ì „ë¬¸ê°€', 'ìŠ¤í¬ì¸  ì—ì´ì „íŠ¸/ë§ˆì¼€í„°', 'ì „ì‹œ/ê³µì—° ê¸°íšì', 'í†µë²ˆì—­ì‚¬',
            'ë…¸ë¬´ì‚¬', 'ê°ì •í‰ê°€ì‚¬', 'ê´€ì„¸ì‚¬', 'ë³€ë¦¬ì‚¬', '1ì¸ í¬ë¦¬ì—ì´í„°/ìœ íŠœë²„',
            'ì›Œì¼€ì´ì…˜ í”„ë¦¬ëœì„œ', 'ê³µê°„/ì¸í…Œë¦¬ì–´ ë””ìì´ë„ˆ', 'ë©”íƒ€ë²„ìŠ¤/VR í¬ë¦¬ì—ì´í„°', 'ë°ì´í„° ì‚¬ì´ì–¸í‹°ìŠ¤íŠ¸'
        ],
        # RIASEC ìœ í˜• (ì„ì˜ ë§¤í•‘ ì˜ˆì‹œ)
        'Holland_Code': [
            'EC', 'EC', 'EI', 'CE', 'EC', 'IR', 'EI', 'IR', 'IR', 'EC',
            'ES', 'CS', 'CS', 'CS', 'CS', 'ES', 'SA', 'CS', 'IA', 'IR',
            'IS', 'IR', 'SC', 'SI', 'IR', 'IS', 'AE', 'AE', 'AI', 'AE', 'AE',
            'AE', 'RI', 'SE', 'SE', 'RA', 'RI', 'RI', 'RI', 'RI', 'IR',
            'RI', 'RE', 'ES', 'AE', 'AS', 'EC', 'EC', 'CE', 'IE', 'AE',
            'AE', 'AR', 'AI', 'IR'
        ],
        'Money': [50, 55, 50, 40, 50, 35, 25, 35, 40, 40, 45, 35, 25, 25, 15, 25, 15, 20, 30, 30, 45, 45, 30, 30, 35, 40, 25, 30, 35, 15, 25, 25, 45, 25, 15, 25, 45, 40, 40, 45, 35, 40, 30, 25, 20, 30, 35, 40, 35, 45, 25, 20, 25, 30, 45],
        'WLB': [5, 5, 5, 10, 10, 20, 15, 15, 15, 15, 10, 25, 30, 30, 35, 10, 30, 35, 20, 30, 10, 15, 30, 10, 20, 25, 5, 5, 15, 10, 10, 10, 15, 15, 15, 5, 10, 15, 20, 20, 25, 5, 25, 10, 10, 25, 25, 20, 25, 10, 10, 35, 10, 20, 20],
        'Culture': [10, 5, 10, 10, 10, 15, 35, 25, 15, 10, 10, 10, 10, 5, 5, 10, 15, 10, 15, 10, 10, 10, 10, 10, 10, 10, 30, 15, 25, 35, 25, 20, 10, 15, 15, 15, 10, 15, 10, 5, 15, 10, 15, 20, 25, 15, 10, 5, 10, 10, 45, 20, 25, 25, 15],
        'Location': [20, 20, 20, 20, 15, 10, 10, 10, 10, 15, 15, 10, 10, 10, 10, 25, 10, 10, 5, 10, 15, 10, 10, 25, 15, 5, 20, 25, 10, 25, 25, 25, 10, 25, 30, 30, 15, 10, 10, 10, 5, 20, 15, 25, 25, 15, 15, 15, 15, 15, 10, 10, 25, 10, 10],
        'Stability': [15, 15, 15, 20, 15, 20, 15, 15, 20, 20, 20, 20, 25, 30, 35, 30, 30, 25, 30, 20, 20, 20, 20, 25, 20, 20, 20, 25, 15, 15, 15, 20, 20, 20, 25, 25, 20, 20, 20, 20, 20, 25, 15, 20, 20, 15, 15, 20, 15, 20, 10, 15, 15, 15, 10]
    }
    return pd.DataFrame(data)

df = load_data()

# -----------------------------------------------------------------------------
# 3. ë©”ì¸ íƒ€ì´í‹€
# -----------------------------------------------------------------------------
st.title("ğŸ§­ ì§„ë¡œ ë‚˜ì¹¨ë°˜ (Career Compass)")
st.markdown("##### 1ë‹¨ê³„: í™€ë€ë“œ ì ì„± ê²€ì‚¬ â¡ï¸ 2ë‹¨ê³„: ì§ì—… ê°€ì¹˜ê´€ ì„¤ì •")
st.divider()

# íƒ­ êµ¬ì„±
tab_holland, tab_balance, tab_result = st.tabs(["1ï¸âƒ£ í™€ë€ë“œ ì ì„± ê²€ì‚¬", "2ï¸âƒ£ ê°€ì¹˜ê´€ ë°¸ëŸ°ìŠ¤ ì„¤ì •", "3ï¸âƒ£ ìµœì¢… ì¶”ì²œ ê²°ê³¼"])

# -----------------------------------------------------------------------------
# [TAB 1] í™€ë€ë“œ ì ì„± ê²€ì‚¬ (ê°„ì´)
# -----------------------------------------------------------------------------
with tab_holland:
    st.subheader("ë‚˜ì˜ í¥ë¯¸ ìœ í˜• ì°¾ê¸° (RIASEC)")
    st.write("ê° ì§ˆë¬¸ì— ëŒ€í•´ **ì–¼ë§ˆë‚˜ í¥ë¯¸ê°€ ìˆëŠ”ì§€** ì ìˆ˜ë¥¼ ë§¤ê²¨ì£¼ì„¸ìš”. (1ì : ì‹«ìŒ ~ 5ì : ë§¤ìš° ì¢‹ìŒ)")
    
    col1, col2 = st.columns(2)
    
    with col1:
        score_R = st.slider("ğŸ”§ [R] ê¸°ê³„, ë„êµ¬, ì‚¬ë¬¼ì„ ë‹¤ë£¨ëŠ” í™œë™ì„ ì¢‹ì•„í•˜ë‚˜ìš”?", 1, 5, 3)
        score_I = st.slider("ğŸ”¬ [I] ê´€ì°°í•˜ê³ , íƒêµ¬í•˜ê³ , ë¶„ì„í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ë‚˜ìš”?", 1, 5, 3)
        score_A = st.slider("ğŸ¨ [A] ì°½ì˜ì ì´ê³  ì˜ˆìˆ ì ì¸ í‘œí˜„ í™œë™ì„ ì¢‹ì•„í•˜ë‚˜ìš”?", 1, 5, 3)
        
    with col2:
        score_S = st.slider("ğŸ¤ [S] ë‹¤ë¥¸ ì‚¬ëŒì„ ë•ê±°ë‚˜ ê°€ë¥´ì¹˜ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ë‚˜ìš”?", 1, 5, 3)
        score_E = st.slider("ğŸ¤ [E] ë‚¨ì„ ì„¤ë“í•˜ê±°ë‚˜ ë¦¬ë“œí•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ë‚˜ìš”?", 1, 5, 3)
        score_C = st.slider("ğŸ—‚ï¸ [C] ìë£Œë¥¼ ì •ë¦¬í•˜ê³  ê·œì¹™ì„ ë”°ë¥´ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ë‚˜ìš”?", 1, 5, 3)

    # ê²°ê³¼ ê³„ì‚°
    scores = {'R': score_R, 'I': score_I, 'A': score_A, 'S': score_S, 'E': score_E, 'C': score_C}
    sorted_scores = sorted(scores.items(), key=lambda item: item[1], reverse=True)
    top_code = sorted_scores[0][0] + sorted_scores[1][0] # ìƒìœ„ 2ê°œ ì½”ë“œ ì¡°í•©
    
    st.info(f"ğŸ‘‰ ë‹¹ì‹ ì˜ ì¶”ì • í™€ë€ë“œ ì½”ë“œëŠ” **[{top_code}]** ìœ í˜•ì…ë‹ˆë‹¤.")
    # ì„¸ì…˜ ìƒíƒœì— ì €ì¥ (ë‹¤ë¥¸ íƒ­ì—ì„œ ì“°ê¸° ìœ„í•´)
    st.session_state['user_holland_code'] = top_code[0] # ê°€ì¥ ë†’ì€ ìœ í˜• 1ê°œë§Œ í•„í„°ë§ìš©ìœ¼ë¡œ ì‚¬ìš©

# -----------------------------------------------------------------------------
# [TAB 2] ê°€ì¹˜ê´€ ë°¸ëŸ°ìŠ¤ ì„¤ì • (ì§ì„ í˜• ìŠ¬ë¼ì´ë”)
# -----------------------------------------------------------------------------
with tab_balance:
    st.subheader("ì§ì—… ê°€ì¹˜ê´€ ì„¤ì •")
    st.write("ì§ì—…ì„ ì„ íƒí•  ë•Œ **ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ë¹„ìœ¨**ì„ ì¡°ì •í•˜ì„¸ìš”.")
    
    # ì§ì„ í˜• ìŠ¬ë¼ì´ë” UI
    val_money = st.slider("ğŸ’° ëˆ (Money)", 0, 100, 50)
    val_wlb = st.slider("ğŸ§˜ ì›Œë¼ë°¸ (WLB)", 0, 100, 50)
    val_culture = st.slider("ğŸ¨ ë¬¸í™” (Culture)", 0, 100, 20)
    val_location = st.slider("ğŸ“ ê·¼ë¬´ì§€ (Location)", 0, 100, 30)
    val_stability = st.slider("ğŸ›¡ï¸ ì•ˆì •ì„± (Stability)", 0, 100, 50)
    
    # ì‚¬ìš©ì ì…ë ¥ ì´í•© ê³„ì‚°
    total_input = val_money + val_wlb + val_culture + val_location + val_stability
    if total_input == 0: total_input = 1 # 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€

    # ì •ê·œí™” (ì‚¬ìš©ì ì…ë ¥ì„ 100ì  ë§Œì ìœ¼ë¡œ í™˜ì‚°)
    user_vector = [
        (val_money / total_input) * 100,
        (val_wlb / total_input) * 100,
        (val_culture / total_input) * 100,
        (val_location / total_input) * 100,
        (val_stability / total_input) * 100
    ]
    
    # ë¯¸ë¦¬ë³´ê¸° ì°¨íŠ¸
    fig = go.Figure()
    fig.add_trace(go.Bar(
        x=['Money', 'WLB', 'Culture', 'Location', 'Stability'],
        y=user_vector,
        marker_color=['#636EFA', '#EF553B', '#00CC96', '#AB63FA', '#FFA15A']
    ))
    fig.update_layout(title="ë‚˜ì˜ ê°€ì¹˜ê´€ ë¹„ì¤‘ (ìë™ í™˜ì‚°ë¨)", yaxis_range=[0, 60], height=300)
    st.plotly_chart(fig, use_container_width=True)

# -----------------------------------------------------------------------------
# [TAB 3] ìµœì¢… ì¶”ì²œ ê²°ê³¼
# -----------------------------------------------------------------------------
with tab_result:
    st.subheader("ğŸ¯ AI ì§ì—… ì¶”ì²œ")
    
    if st.button("ì¶”ì²œ ì§ì—… ë³´ê¸° (Click)", type="primary"):
        # 1. ìœ ì‚¬ë„ ê³„ì‚° ë¡œì§ (ìœ í´ë¦¬ë“œ ê±°ë¦¬)
        def calculate_similarity(row):
            job_vector = np.array([row['Money'], row['WLB'], row['Culture'], row['Location'], row['Stability']])
            user_vec = np.array(user_vector)
            # ê±°ë¦¬ê°€ ê°€ê¹Œìš¸ìˆ˜ë¡ ìœ ì‚¬í•¨ (ì ìˆ˜í™”: 100 - ê±°ë¦¬)
            dist = np.linalg.norm(job_vector - user_vec)
            return 100 - dist

        # ëª¨ë“  ì§ì—…ì— ëŒ€í•´ ì ìˆ˜ ê³„ì‚°
        df['Match_Score'] = df.apply(calculate_similarity, axis=1)
        
        # 2. í™€ë€ë“œ ì½”ë“œë¡œ í•„í„°ë§ (ì˜µì…˜)
        user_type = st.session_state.get('user_holland_code', 'R') # ê¸°ë³¸ê°’ R
        
        # ì¶”ì²œ 1: ê°€ì¹˜ê´€ì´ ê°€ì¥ ì˜ ë§ëŠ” ì§ì—… (TOP 5)
        best_match = df.sort_values(by='Match_Score', ascending=False).head(5)
        
        # ì¶”ì²œ 2: í™€ë€ë“œ ìœ í˜•ì´ ì¼ì¹˜í•˜ëŠ” ì§ì—… ì¤‘ ê°€ì¹˜ê´€ ë§ëŠ” ê²ƒ
        holland_match = df[df['Holland_Code'].str.contains(user_type)].sort_values(by='Match_Score', ascending=False).head(5)

        # ê²°ê³¼ ì¶œë ¥
        col_res1, col_res2 = st.columns(2)
        
        with col_res1:
            st.success("ğŸ† ë‹¹ì‹ ì˜ ê°€ì¹˜ê´€ê³¼ ë”± ë§ëŠ” ì§ì—…")
            for idx, row in best_match.iterrows():
                st.markdown(f"**{row['ì§ì—…êµ°']}** (ì¼ì¹˜ë„: {row['Match_Score']:.1f}%)")
                st.progress(int(row['Match_Score']))
        
        with col_res2:
            st.info(f"ğŸ§© ë‹¹ì‹ ì˜ ì ì„±({user_type}í˜•)ì„ ê³ ë ¤í•œ ì¶”ì²œ")
            if not holland_match.empty:
                for idx, row in holland_match.iterrows():
                    st.markdown(f"**{row['ì§ì—…êµ°']}** (ì¼ì¹˜ë„: {row['Match_Score']:.1f}%)")
                    st.progress(int(row['Match_Score']))
            else:
                st.write("í•´ë‹¹ ìœ í˜•ì˜ ì§ì—… ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")
                
        st.markdown("---")
        st.dataframe(best_match[['ì§ì—…êµ°', 'Holland_Code', 'Money', 'WLB', 'Stability', 'Match_Score']].set_index('ì§ì—…êµ°'))
